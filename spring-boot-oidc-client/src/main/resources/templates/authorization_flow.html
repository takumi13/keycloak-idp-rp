<!doctype html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Authorization Flow</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input[type="text"], input[type="url"], textarea { width:100%; padding:8px; box-sizing:border-box; }
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    .actions { margin-top:16px; }
    .hint { color:#666; font-size:0.9em; }
  </style>
</head>
<body>
  <h1>Authorization Flow</h1>

  <!-- Thymeleaf が設定した値を data- 属性で保持 -->
  <div id="initial" th:attr="data-code_verifier=${code_verifier},data-state=${state},data-nonce=${nonce},data-code_challenge=${code_challenge},data-code_challenge_method=${code_challenge_method}"></div>

  <form id="authForm" method="post" th:action="@{/authorize}">
    <label>authorization_endpoint
      <input type="text" name="authorization_endpoint" id="authorization_endpoint"
             value="https://localhost:8443/realms/myrealm/protocol/openid-connect/auth" />
    </label>

    <div class="row">
      <div class="col">d
        <label>response_type
          <input type="text" name="response_type" id="response_type" value="code" />
        </label>
      </div>
      <div class="col">
        <label>client_id
          <input type="text" name="client_id" id="client_id" value="semi_client" />
        </label>
      </div>
    </div>

    <label>redirect_uri
      <input type="text" name="redirect_uri" id="redirect_uri" value="https://localhost:8081/callback" />
    </label>

    <label>state
      <!-- フロント表示用に state をセット（フォームにも送る） -->
      <input type="text" id="state" name="state">
    </label>

    <label>nonce
      <input type="text" id="nonce" name="nonce">
    </label>

    <label>code_challenge
      <!-- code_challenge はサーバへ送信する -->
      <input type="text" id="code_challenge" name="code_challenge">
    </label>

    <label>code_challenge_method
      <input type="text" id="code_challenge_method" name="code_challenge_method" value="S256">
    </label>

    <label>code_verifier（表示のみ。サーバへは送信しません）
      <!-- disabled にして送信されないようにする -->
      <input type="text" id="code_verifier" name="display_code_verifier" disabled>
    </label>

    <div>
      <button type="submit">Authorize</button>
    </div>
  </form>

  <script>
    // Thymeleaf で埋めた data- 属性から初期値を設定する
    (function(){
      const initial = document.getElementById('initial');
      if (!initial) return;
      const codeVerifier = initial.dataset.code_verifier || '';
      const state = initial.dataset.state || '';
      const nonce = initial.dataset.nonce || '';
      const codeChallenge = initial.dataset.code_challenge || '';
      const codeChallengeMethod = initial.dataset.code_challenge_method || 'S256';

      // set inputs
      document.getElementById('code_verifier').value = codeVerifier;
      document.getElementById('state').value = state;
      document.getElementById('nonce').value = nonce;
      document.getElementById('code_challenge').value = codeChallenge;
      document.getElementById('code_challenge_method').value = codeChallengeMethod;

      // Authorization request: PKCE に従い code_verifier を送らず code_challenge と method を送る（フォームは既に構成済み）
      // 追加: ここで必要なら authorization_endpoint, client_id, redirect_uri を初期化する（Thymeleaf経由で埋められる場合は省略可）
    })();
  </script>
</body>
</html>