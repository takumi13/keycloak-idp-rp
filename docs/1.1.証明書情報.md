# 1. 証明書関連ファイル一覧と役割
## 1-1. Keycloak 側

| ファイルパス                                 | 種別                  | 主な役割 / どこで使うか                                                                                                                                                                                  |
| -------------------------------------- | ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `certs/keycloak-https-server.key`      | 秘密鍵 (PEM)           | Keycloak の HTTPS サーバ用秘密鍵。`KC_HTTPS_CERTIFICATE_KEY_FILE=/opt/keycloak/conf/tls.key` にマウントされる想定。                                                                                                |
| `certs/keycloak-https-server.crt`      | サーバ証明書 (PEM)        | Keycloak の HTTPS サーバ証明書 (Subject: `CN=localhost`, Issuer: `CN=test-ca`)。`KC_HTTPS_CERTIFICATE_FILE=/opt/keycloak/conf/tls.crt` にマウント。                                                          |
| `certs/keycloak-server.csr`            | CSR                 | 上記サーバ証明書を発行するために使った署名要求。**運用時は未使用（再発行時のための控え）。**                                                                                                                                               |
| `certs/keycloak-server-truststore.p12` | TrustStore (PKCS12) | Keycloak サーバ証明書（または CA）を格納した truststore。クライアント側（Spring Boot）用に作成したもの。`spring-boot-oidc-client/src/main/resources/ssl/keycloak-server-truststore.p12` にコピーして利用。                                 |
| `ssl/truststore.p12`                   | TrustStore (PKCS12) | Keycloak が mTLS で受け取る **クライアント証明書 (CN=semi, …)** を検証するための truststore。`KC_HTTPS_TRUST_STORE_FILE=/opt/keycloak/conf/truststore.p12` としてマウントし、`KC_HTTPS_CLIENT_AUTH=request/required` と組み合わせて使用。 |

※ ssl/truststore.p12 はプロジェクト直下 ./ssl ディレクトリにあるもの（Keycloak コンテナにマウントされる側）です。

## 1-2. Spring Boot OIDC クライアント側 (spring-boot-oidc-client)

| ファイルパス                                                                           | 種別                  | 主な役割 / どこで使うか                                                                                                                                                                                                                   |
| -------------------------------------------------------------------------------- | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `spring-boot-oidc-client/src/main/resources/ssl/oidc-https-keystore.p12`         | KeyStore (PKCS12)   | **Spring Boot アプリ自身の HTTPS サーバ証明書＋秘密鍵。** `server.ssl.key-store=classpath:ssl/oidc-https-keystore.p12` で利用。Subject は `CN=localhost, OU=Dev, O=YourOrg, L=Tokyo, ST=Tokyo, C=JP`。                                                 |
| `spring-boot-oidc-client/src/main/resources/ssl/oidc-mtls-client-keystore.p12`   | KeyStore (PKCS12)   | **Keycloak への mTLS で使うクライアント証明書＋秘密鍵。** `keycloak.mtls.key-store=ssl/oidc-mtls-client-keystore.p12` で読み込み、`TokenClientService` が HttpClient の `SSLContext` にセット。Subject は `CN=semi, OU=Dev, O=YourOrg, L=Tokyo, ST=Tokyo, C=JP`。 |
| `spring-boot-oidc-client/src/main/resources/ssl/client-cert.pem`                 | クライアント証明書 (PEM)     | 上記 `oidc-mtls-client-keystore.p12` からエクスポートした PEM 形式のクライアント証明書。Keycloak 側の truststore 生成（`ssl/truststore.p12`）や、ブラウザ・ツールへのインポートに利用。                                                                                             |
| `spring-boot-oidc-client/src/main/resources/ssl/oidc-mtls-client-truststore.p12` | TrustStore (PKCS12) | **`https://localhost:8081` へ mTLS でアクセスしてくるクライアント証明書を検証するための truststore。** 現状は `client-cert.pem` をインポートした構成を想定。`server.ssl.trust-store=classpath:ssl/oidc-mtls-client-truststore.p12` で利用。                                      |
| `spring-boot-oidc-client/src/main/resources/ssl/keycloak-server-truststore.p12`  | TrustStore (PKCS12) | Keycloak HTTPS サーバ証明書（または CA）を格納した truststore。`keycloak.mtls.trust-store=ssl/keycloak-server-truststore.p12` として `TokenClientService` が使用し、Keycloak 側の証明書検証に利用。                                                                 |
| `spring-boot-oidc-client/src/main/resources/ssl/client-OLD-20251115.p12`         | KeyStore (バックアップ)   | 旧クライアント keystore の退避。**運用では未使用。削除しても構成には影響なし。**                                                                                                                                                                                 |
| `spring-boot-oidc-client/src/main/resources/ssl/truststore-OLD-20251115.p12`     | TrustStore (バックアップ) | 旧 truststore の退避。**運用では未使用。削除しても構成には影響なし。**                                                                                                                                                                                     |

## 1-3. 直下 ./ssl に残っている旧ファイル（参考）

| ファイルパス                    | 種別         | 現状                                                                                   |
| ------------------------- | ---------- | ------------------------------------------------------------------------------------ |
| `ssl/app-keystore.p12`    | KeyStore   | 旧: Spring Boot HTTPS 用 keystore。**現在は `resources/ssl/oidc-https-keystore.p12` が現行。** |
| `ssl/client-keystore.p12` | KeyStore   | 旧: クライアント証明書用 keystore。**現在は `resources/ssl/oidc-mtls-client-keystore.p12` が現行。**    |
| `ssl/client-cert.pem`     | 証明書 (PEM)  | 旧クライアント証明書 PEM。必要がなければ削除可。                                                           |
| `ssl/truststore.p12`      | TrustStore | **Keycloak コンテナにマウントしている現行 truststore。** ここだけは「Keycloak 側の truststore」としてまだ現役。       |

# 2. 証明書／KeyStore／TrustStore の生成コマンド一覧

- 以下、プロジェクトルート `keycloak-idp-rp` をカレントディレクトリとして想定。

## 2-1. 共通: CA と Keycloak HTTPS サーバ証明書の作成

``` sh
# ディレクトリ作成（なければ）
mkdir -p certs ssl

# 1. 開発用 CA 作成
openssl genrsa -out certs/ca.key 2048

openssl req -x509 -new -key certs/ca.key \
  -sha256 -days 365 \
  -out certs/ca.crt \
  -subj "/CN=test-ca"

# 2. Keycloak HTTPS サーバ用秘密鍵
openssl genrsa -out certs/keycloak-https-server.key 2048

# 3. Keycloak HTTPS サーバ用 CSR
openssl req -new \
  -key certs/keycloak-https-server.key \
  -out certs/keycloak-server.csr \
  -subj "/CN=localhost"

# 4. CA でサーバ証明書を発行
openssl x509 -req \
  -in certs/keycloak-server.csr \
  -CA certs/ca.crt \
  -CAkey certs/ca.key \
  -CAcreateserial \
  -out certs/keycloak-https-server.crt \
  -days 365 \
  -sha256
```

## 2-2. Spring Boot 側: HTTPS サーバ用 keystore（oidc-https-keystore.p12）

``` sh
mkdir -p spring-boot-oidc-client/src/main/resources/ssl

keytool -genkeypair \
  -alias oidc-client \
  -keyalg RSA \
  -keysize 2048 \
  -dname "CN=localhost, OU=Dev, O=YourOrg, L=Tokyo, ST=Tokyo, C=JP" \
  -validity 3650 \
  -storetype PKCS12 \
  -keystore spring-boot-oidc-client/src/main/resources/ssl/oidc-https-keystore.p12 \
  -storepass changeit \
  -keypass changeit \
  -ext "SAN=dns:localhost,ip:127.0.0.1,ip:::1"
```

- `application.properties` 側では以下と対応：

```
server.ssl.enabled=true
server.ssl.key-store=classpath:ssl/oidc-https-keystore.p12
server.ssl.key-store-password=changeit
server.ssl.key-store-type=PKCS12
server.ssl.key-alias=oidc-client
```

## 2-3. Spring Boot → Keycloak mTLS 用クライアント証明書（oidc-mtls-client-keystore.p12 他）

``` sh
keytool -genkeypair \
  -alias oidc-client-user \
  -keyalg RSA \
  -keysize 2048 \
  -dname "CN=semi, OU=Dev, O=YourOrg, L=Tokyo, ST=Tokyo, C=JP" \
  -validity 3650 \
  -storetype PKCS12 \
  -keystore spring-boot-oidc-client/src/main/resources/ssl/oidc-mtls-client-keystore.p12 \
  -storepass changeit \
  -keypass changeit
```

## 2-3-2. PEM 形式のクライアント証明書エクスポート（client-cert.pem）

``` sh
keytool -exportcert \
  -alias oidc-client-user \
  -keystore spring-boot-oidc-client/src/main/resources/ssl/oidc-mtls-client-keystore.p12 \
  -storetype PKCS12 \
  -storepass changeit \
  -rfc \
  -file spring-boot-oidc-client/src/main/resources/ssl/client-cert.pem
```

## 2-4. Keycloak 側: クライアント証明書検証用 truststore（ssl/truststore.p12）

- ※ Keycloak コンテナにマウントしている truststore。

``` sh
# プロジェクト直下の ssl/ 配下に truststore を作る
mkdir -p ssl

keytool -importcert \
  -alias oidc-client-user \
  -file spring-boot-oidc-client/src/main/resources/ssl/client-cert.pem \
  -keystore ssl/truststore.p12 \
  -storetype PKCS12 \
  -storepass changeit \
  -noprompt
```

- Keycloak の docker-compose.yml 側では例えば以下のようにマウント＆設定：

``` yml
  keycloak:
    # ...
    environment:
      KC_HTTPS_CERTIFICATE_FILE: "/opt/keycloak/conf/tls.crt"
      KC_HTTPS_CERTIFICATE_KEY_FILE: "/opt/keycloak/conf/tls.key"
      KC_HTTPS_TRUST_STORE_FILE: "/opt/keycloak/conf/truststore.p12"
      KC_HTTPS_TRUST_STORE_PASSWORD: "changeit"
      KC_HTTPS_TRUST_STORE_TYPE: "PKCS12"
      KC_HTTPS_CLIENT_AUTH: "request" # or "required"
    volumes:
      - ./certs/keycloak-https-server.crt:/opt/keycloak/conf/tls.crt:ro
      - ./certs/keycloak-https-server.key:/opt/keycloak/conf/tls.key:ro
      - ./ssl/truststore.p12:/opt/keycloak/conf/truststore.p12:ro
```

## 2-5. Spring Boot 側: Keycloak サーバ証明書検証用 truststore（keycloak-server-truststore.p12）

``` sh
# Keycloak HTTPS サーバ証明書を truststore に登録
keytool -importcert \
  -alias keycloak-https-server \
  -file certs/keycloak-https-server.crt \
  -keystore spring-boot-oidc-client/src/main/resources/ssl/keycloak-server-truststore.p12 \
  -storetype PKCS12 \
  -storepass changeit \
  -noprompt
```

- application.properties での対応：

```
keycloak.mtls.trust-store=ssl/keycloak-server-truststore.p12
keycloak.mtls.trust-store-password=changeit
keycloak.mtls.trust-store-type=PKCS12
```

## 2-6. Spring Boot 側: /https://localhost:8081 への mTLS アクセス用 truststore（oidc-mtls-client-truststore.p12）

- 「RP 側でクライアント証明書を検証する」用途。
- Keycloak → RP の mTLS を将来やる場合などに利用。

``` sh
keytool -importcert \
  -alias oidc-client-user \
  -file spring-boot-oidc-client/src/main/resources/ssl/client-cert.pem \
  -keystore spring-boot-oidc-client/src/main/resources/ssl/oidc-mtls-client-truststore.p12 \
  -storetype PKCS12 \
  -storepass changeit \
  -noprompt
```

- `application.properties` 側：

```
server.ssl.client-auth=need
server.ssl.trust-store=classpath:ssl/oidc-mtls-client-truststore.p12
server.ssl.trust-store-password=changeit
server.ssl.trust-store-type=PKCS12
```